Given a probit model  y=1[y* > 0] where y* = x1 β + zδ + u, and u ~ N(0,1), without losing generality, z can be represented as z = x1 θ1 + x2 θ2 + v. When u is correlated with v, there will be an issue of endogeneity. This can be caused by omitted variables and measurement errors. There are also many cases where z is partially determined by y and endogeneity issue arises. For instance, in a model evaluating the effect of different patient features on their choice of whether going to hospital, y is the choice and z is the amount of the medicine a respondent took, then it is very intuitive that more often the respondent goes to hospital, it is more likely that she took more medicine, hence endogeneity issue arises. When there are endogenous explanatory variables, the estimator generated by usual estimation procedure will be inconsistent, then the corresponding estimated Average Partial Effect (APE)  will be inconsistent, too.
To address this issue, there are usually two different estimation procedure to generate consistent estimators. Under the normality assumption v~N(0,σ2), u = ρv + ε must hold, where ρ = cov(u , v)/σ2 and ε~N(0,1-ρ2 σ2). Then the equation for y* can be rewritten as y* = x1 β + zδ + ρv + ε.
This model can be consistently estimated by 2-Stage Least Square (2SLS):
1) Regress z on (x1, x2) and obtain the consistent estimator 
  
    
      
        
          
            
              θ
              ^
            
          
        
      
    
    {\displaystyle {\widehat {\theta }}}
   and the residual 
  
    
      
        
          
            
              v
              ^
            
          
        
      
    
    {\displaystyle {\hat {v}}}
   ;
2) Estimate the binary response model on (x1, z, 
  
    
      
        
          
            
              v
              ^
            
          
        
      
    
    {\displaystyle {\hat {v}}}
  ) and get the consistent estimator for the scaled coefficients (βρσ, δρσ, ρρσ) ≡ (β, δ, ρ)/√(1 - ρ2 σ2 );
Then (y = 1│x, z) = Φ ( x1 
  
    
      
        
          
            
              β
              ^
            
          
        
      
    
    {\displaystyle {\hat {\beta }}}
  ρσ + z
  
    
      
        
          
            
              δ
              ^
            
          
        
      
    
    {\displaystyle {\hat {\delta }}}
  ρσ + 
  
    
      
        
          
            
              ρ
              ^
            
          
        
      
    
    {\displaystyle {\hat {\rho }}}
  ρσ
  
    
      
        
          
            
              v
              ^
            
          
        
      
    
    {\displaystyle {\hat {v}}}
  ) . Since the APE of variable 
  
    
      
        
          
            
              w
              ~
            
          
        
      
    
    {\displaystyle {\tilde {w}}}
   at (
  
    
      
        
          
            
              x
              ~
            
          
        
      
    
    {\displaystyle {\tilde {x}}}
  ,
  
    
      
        
          
            
              z
              ~
            
          
        
      
    
    {\displaystyle {\tilde {z}}}
  ) is given by
Ev 
  
    
      
        [
        
          
            
              ∂
              ϕ
              (
              
                x
                
                  1
                
              
              
                β
                
                  ρ
                  σ
                
              
              +
              z
              
                δ
                
                  ρ
                  σ
                
              
              +
              
                ρ
                
                  ρ
                  σ
                
              
              v
              )
            
            
              ∂
              
                
                  
                    w
                    ~
                  
                
              
            
          
        
        
          
            |
          
          
            (
          
        
        
          
            
              x
              ~
            
          
        
      
    
    {\displaystyle [{\frac {\partial \phi (x_{1}\beta _{\rho \sigma }+z\delta _{\rho \sigma }+\rho _{\rho \sigma }v)}{\partial {\tilde {w}}}}|_{(}{\tilde {x}}}
  ,
  
    
      
        
          
            
              z
              ~
            
          
        
      
    
    {\displaystyle {\tilde {z}}}
  )]
By Law of Large Number, a consistent estimator is given as

  
    
      
        
          
            1
            N
          
        
      
    
    {\displaystyle {\frac {1}{N}}}
  
  
    
      
        
          ∑
          
            i
            =
            1
          
          
            n
          
        
      
    
    {\displaystyle \sum _{i=1}^{n}}
  
  
    
      
        
          
            
              ∂
              ϕ
              (
              
                x
                
                  1
                
              
              
                
                  
                    
                      β
                      ^
                    
                  
                
                
                  ρ
                  σ
                
              
              +
              z
              
                
                  
                    
                      δ
                      ^
                    
                  
                
                
                  ρ
                  σ
                
              
              +
              
                
                  
                    
                      ρ
                      ^
                    
                  
                
                
                  ρ
                  σ
                
              
              
                
                  
                    
                      v
                      ^
                    
                  
                
                
                  i
                
              
              )
            
            
              ∂
              
                
                  
                    w
                    ~
                  
                
              
            
          
        
        
          
            |
          
          
            (
          
        
        
          
            
              x
              ~
            
          
        
      
    
    {\displaystyle {\frac {\partial \phi (x_{1}{\hat {\beta }}_{\rho \sigma }+z{\hat {\delta }}_{\rho \sigma }+{\hat {\rho }}_{\rho \sigma }{\hat {v}}_{i})}{\partial {\tilde {w}}}}|_{(}{\tilde {x}}}
  ,
  
    
      
        
          
            
              z
              ~
            
          
        
      
    
    {\displaystyle {\tilde {z}}}
  )
This model can also be consistently estimated by conditional Maximum Likelihood Method. Because P(y, z│x) = P (y│z, x) P (z| x) where P (y│x, z) is given by

  
    
      
        [
        ϕ
        (
        
          
            
              
                x
                
                  1
                
              
              (
              β
              −
              ρ
              
                θ
                
                  1
                
              
              )
              −
              
                x
                
                  2
                
              
              ρ
              
                θ
                
                  2
                
              
              +
              z
              (
              δ
              +
              ρ
              )
            
            
              (
              1
              −
              
                ρ
                
                  2
                
              
              
                σ
                
                  2
                
              
            
          
        
        )
        
          ]
          
            y
          
        
      
    
    {\displaystyle [\phi ({\frac {x_{1}(\beta -\rho \theta _{1})-x_{2}\rho \theta _{2}+z(\delta +\rho )}{\sqrt {(1-\rho ^{2}\sigma ^{2}}}})]^{y}}
   
  
    
      
        [
        1
        −
        ϕ
        (
        
          
            
              
                x
                
                  1
                
              
              (
              β
              −
              ρ
              
                θ
                
                  1
                
              
              )
              −
              
                x
                
                  2
                
              
              ρ
              
                θ
                
                  2
                
              
              +
              z
              (
              δ
              +
              ρ
              )
            
            
              (
              1
              −
              
                ρ
                
                  2
                
              
              
                σ
                
                  2
                
              
            
          
        
        )
        
          ]
          
            1
            −
            y
          
        
      
    
    {\displaystyle [1-\phi ({\frac {x_{1}(\beta -\rho \theta _{1})-x_{2}\rho \theta _{2}+z(\delta +\rho )}{\sqrt {(1-\rho ^{2}\sigma ^{2}}}})]^{1-y}}
  
and P(z│x) is given by 
  
    
      
        ϕ
        (
        
          
            
              z
              −
              
                x
                
                  1
                
              
              
                θ
                
                  1
                
              
              −
              
                x
                
                  2
                
              
              
                θ
                
                  2
                
              
            
            σ
          
        
        )
      
    
    {\displaystyle \phi ({\frac {z-x_{1}\theta _{1}-x_{2}\theta _{2}}{\sigma }})}
  
Then the log-likelihood function for maximization is given by:

  
    
      
        
          ∑
          
            i
            =
            1
          
          
            n
          
        
      
    
    {\displaystyle \sum _{i=1}^{n}}
   
  
    
      
        
          y
          
            i
          
        
        log
        ⁡
        [
        ϕ
        (
        
          
            
              
                x
                
                  1
                
              
              i
              (
              β
              −
              ρ
              
                θ
                
                  1
                
              
              )
              −
              
                x
                
                  2
                
              
              i
              ρ
              
                θ
                
                  2
                
              
              +
              
                z
                
                  i
                
              
              (
              δ
              +
              ρ
              )
            
            
              (
              1
              −
              
                ρ
                
                  2
                
              
              
                σ
                
                  2
                
              
            
          
        
        )
        ]
      
    
    {\displaystyle y_{i}\log[\phi ({\frac {x_{1}i(\beta -\rho \theta _{1})-x_{2}i\rho \theta _{2}+z_{i}(\delta +\rho )}{\sqrt {(1-\rho ^{2}\sigma ^{2}}}})]}
  

  
    
      
        +
        (
        1
        −
        
          y
          
            i
          
        
        )
        log
        ⁡
        [
        1
        −
        ϕ
        (
        
          
            
              
                x
                
                  1
                
              
              i
              (
              β
              −
              ρ
              
                θ
                
                  1
                
              
              )
              −
              
                x
                
                  2
                
              
              i
              ρ
              
                θ
                
                  2
                
              
              +
              
                z
                
                  i
                
              
              (
              δ
              +
              ρ
              )
            
            
              (
              1
              −
              
                ρ
                
                  2
                
              
              
                σ
                
                  2
                
              
            
          
        
        )
        ]
      
    
    {\displaystyle +(1-y_{i})\log[1-\phi ({\frac {x_{1}i(\beta -\rho \theta _{1})-x_{2}i\rho \theta _{2}+z_{i}(\delta +\rho )}{\sqrt {(1-\rho ^{2}\sigma ^{2}}}})]}
  

  
    
      
        +
        log
        ⁡
        [
        ϕ
        (
        
          
            
              z
              −
              
                x
                
                  1
                
              
              
                θ
                
                  1
                
              
              −
              
                x
                
                  2
                
              
              
                θ
                
                  2
                
              
            
            σ
          
        
        )
        ]
      
    
    {\displaystyle +\log[\phi ({\frac {z-x_{1}\theta _{1}-x_{2}\theta _{2}}{\sigma }})]}
  
Once the consistent estimators are obtained, APE can be calculated following the same procedure given above. All the discussion above is mainly about the probit model. When the distribution assumption is changed, the same logic still applies.
